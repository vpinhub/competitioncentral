<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>VPINHUB | Stream Finals Asset</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Encode+Sans:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">

<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: #020617;
    color: white;
    font-family: 'Encode Sans', sans-serif;
    overflow: hidden;
}

body.is-transparent { background: transparent !important; }
body.is-transparent .glass { background: rgba(0,0,0,0.7); }

.medieval { font-family: 'MedievalSharp', cursive; }
.glass {
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.1);
}

.theme-throwdown { --accent: #f97316; }
.theme-swl { --accent: #d946ef; }

.accent-text { color: var(--accent,#94a3b8); }
.accent-border { border-color: var(--accent,#334155); }

#main-stage {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: clamp(24px,3vh,60px);
    box-sizing: border-box;
}
#main-stage * { min-height: 0; }

.render-mode {
    width: 1920px !important;
    height: 1080px !important;
    padding: 60px !important;
}
.render-mode.banner {
    width: 1200px !important;
    height: 630px !important;
    padding: 40px !important;
}

#selector-overlay {
    position: fixed;
    inset: 0;
    z-index: 100;
    background: #020617;
    display: flex;
    align-items: center;
    justify-content: center;
}

.admin-select {
    background-color: #0f172a;
    border: 1px solid rgba(255,255,255,0.1);
    color: white;
    padding: 0.75rem;
    border-radius: 0.75rem;
    font-size: 0.875rem;
    font-weight: 700;
    width: 100%;
    outline: none;
}
</style>
</head>

<body>

<div id="selector-overlay">
    <div class="glass p-10 rounded-[40px] w-full max-w-2xl border-2 border-white/10">
        <h2 class="medieval text-3xl accent-text uppercase mb-8 text-center">Tournament Finals Selector</h2>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="col-span-2">
                <label class="text-[10px] font-black uppercase tracking-widest text-gray-500 block mb-2">Record Selection</label>
                <select id="json-list" class="admin-select"></select>
            </div>
            <div>
                <label class="text-[10px] font-black uppercase tracking-widest text-gray-500 block mb-2">Background</label>
                <select id="select-transparent" class="admin-select">
                    <option value="false">Solid</option>
                    <option value="true">Transparent</option>
                </select>
            </div>
        </div>

        <div class="flex flex-col gap-3">
            <button onclick="launchFromSelector()" class="bg-white text-black font-black py-4 rounded-xl uppercase text-xs">Display Finals</button>
            <button onclick="downloadFinalsImage()" class="bg-emerald-600 text-white font-black py-4 rounded-xl uppercase text-xs">üì∏ Download JPG (1080p)</button>
            <button onclick="downloadFinalsImage(true)" class="bg-blue-600 text-white font-black py-4 rounded-xl uppercase text-xs">üñºÔ∏è Download Discord Banner</button>
        </div>
    </div>
</div>

<div id="main-stage" class="hidden">
    <div class="flex justify-between items-end border-b-2 accent-border pb-4 mb-8">
        <div>
            <div class="medieval text-lg accent-text uppercase mb-1">Final Standings</div>
            <h1 id="table-name" class="text-6xl xl:text-7xl font-black italic uppercase leading-tight break-words max-w-[900px]">Table</h1>
        </div>
        <div class="text-right">
            <p id="event-period" class="text-xl text-gray-500 font-bold"></p>
            <div class="text-[10px] font-black uppercase tracking-widest bg-white/10 px-4 py-1 rounded-full inline-block mt-2">Official Result</div>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-8 flex-1 overflow-hidden min-h-0">
        <div class="col-span-4 flex flex-col gap-6 min-h-0">
            <div id="winner-banner"></div>
            <div class="glass rounded-3xl p-8 mt-auto flex justify-around items-center border-t-2 accent-border">
                <div class="text-center"><div id="total-players" class="text-4xl font-black italic">0</div><div class="text-[9px] uppercase font-bold text-gray-400">Field Size</div></div>
                <div class="text-center"><div id="avg-score" class="text-4xl font-black italic accent-text">0</div><div class="text-[9px] uppercase font-bold text-gray-400">Average Score</div></div>
            </div>
        </div>

        <div id="lb-viewport" class="col-span-8 glass rounded-[40px] overflow-hidden min-h-0">
            <div id="leaderboard" class="p-6 flex flex-col gap-3"></div>
        </div>
    </div>
</div>

<script>
const AVATAR_BASE = "http://vpinhub.github.io/special-when-lit-leaderboard/img/";
const el = id => document.getElementById(id);

async function init() {
    const res = await fetch('json/list.json');
    const files = await res.json();
    el('json-list').innerHTML = files.map(f =>
        `<option value="${f.name}">${f.name.replace('.json','').replace(/_/g,' ')}</option>`
    ).join('');
}
init();

function launchFromSelector() {
    const file = el('json-list').value;
    if (!file) return;

    el('selector-overlay').classList.add('hidden');

    if (el('select-transparent').value === 'true')
        document.body.classList.add('is-transparent');

    loadData(file);
}

async function loadData(file) {
    const res = await fetch(`json/${file}`);
    const data = await res.json();

    document.body.classList.remove('theme-throwdown','theme-swl');
    document.body.classList.add(
        data.competition?.includes('Throwdown') ? 'theme-throwdown' : 'theme-swl'
    );

    el('main-stage').classList.remove('hidden');

    const players = data.results || [];

    el('table-name').innerText = data.table;
    el('event-period').innerText = data.period;
    el('total-players').innerText = players.length;
    el('avg-score').innerText = players.length ? Math.round(players.reduce((s,p)=>s+p.high,0)/players.length).toLocaleString() : 0;

    const winner = players[0];
    if (winner) {
        el('winner-banner').innerHTML = `
        <div class="glass p-8 rounded-[40px] border-4 accent-border text-center">
            <img src="${AVATAR_BASE}${winner.name.replace(/\s+/g,'_').toLowerCase()}.gif"
                 class="w-40 h-40 rounded-full mx-auto mb-4"
                 onerror="this.src='https://via.placeholder.com/160?text=?'">
            <div class="text-4xl font-black italic uppercase">${winner.name}</div>
        </div>`;
    }

    el('leaderboard').innerHTML = players.map((p,i)=>`
        <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl">
            <div class="flex items-center gap-6">
                <span class="text-3xl font-black italic w-10 ${i<3?'accent-text':'text-gray-600'}">${i+1}</span>
                <span class="text-xl font-bold">${p.name}</span>
            </div>
            <span class="text-2xl font-mono font-bold">${p.high.toLocaleString()}</span>
        </div>
    `).join('');
}

async function downloadFinalsImage(isBanner=false){
    const file = el('json-list').value;
    if (!file) return;

    await loadData(file);

    const stage = el('main-stage');
    stage.classList.add('render-mode');
    if (isBanner) stage.classList.add('banner');

    await new Promise(r=>setTimeout(r,100));

    const canvas = await html2canvas(stage,{backgroundColor:"#020617",scale:1});
    const link=document.createElement('a');
    link.download=file.replace('.json','') + (isBanner?'_banner':'') + '.jpg';
    link.href=canvas.toDataURL("image/jpeg",0.95);
    link.click();

    stage.classList.remove('render-mode','banner');
}
</script>

</body>
</html>
